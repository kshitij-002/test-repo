name: Breachwatcher-24/7

on:
  push:
    branches:
      - main

jobs:
  breachwatcher:
    runs-on: ubuntu-latest  

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2
      with:
        ref: ${{ github.event.before }}
        fetch-depth: 0

    - name: Set up Java
      uses: actions/setup-java@v2
      with:
        distribution: 'adopt'
        java-version: '17'

    - name: Set up Gradle
      uses: gradle/wrapper-action@v2
      with:
        gradle-version: '7.2'

    - name: Build and Test
      run: ./gradlew build

    - name: Execute 24/7 Tickets Check
      run: |
        ./execute_stage.sh tickets_at_risk weekend > tickets_results.txt
        echo "Results:"
        cat tickets_results.txt

    - name: Send Slack Notifications
      if: ${{ success() }}
      run: |
        notifsList=$(./execute_stage.sh tickets_at_risk weekend)
        if [ -n "$notifsList" ]; then
          echo "Sending $(echo "$notifsList" | wc -l) notification(s) to $SLACK_CHANNEL..."
          while IFS= read -r line; do
            echo "Sending ###$line###"
          
            slackSend channel: $SLACK_CHANNEL, color: '#FF0000', message: $line, tokenCredentialId: 'slack-support-tm-integration-token'
          done <<< "$notifsList"
        else
          echo "No notification to send."
